<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pencatat Keuangan v2.6 (Login)</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    
    <style>
        /* Salin SEMUA CSS dari V2.4.1 (Tidak ada perubahan) */
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap');
        :root { --color-hijau: #2ecc71; --color-merah: #e74c3c; --color-biru: #3498db; --color-latar: #f7f7f7; --color-box: #ffffff; --color-teks: #333; --color-bayangan: rgba(0, 0, 0, 0.1); }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Poppins', sans-serif; background-color: var(--color-latar); display: flex; flex-direction: column; align-items: center; justify-content: flex-start; min-height: 100vh; color: var(--color-teks); }
        .container { background-color: var(--color-box); border-radius: 10px; box-shadow: 0 5px 15px var(--color-bayangan); padding: 20px 30px 30px 30px; width: 90%; max-width: 500px; margin: 20px; transition: all 0.3s ease; }
        .tabs { display: flex; margin: 0 -30px 20px -30px; border-bottom: 1px solid #eee; }
        .tabs button { flex: 1; padding: 15px; font-size: 1.1rem; font-weight: 600; border: none; background-color: transparent; color: #999; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.3s ease; }
        .tabs button.active { color: var(--color-biru); border-bottom-color: var(--color-biru); }
        .hidden { display: none; }
        h3 { border-bottom: 2px solid #eee; padding-bottom: 10px; margin: 25px 0 15px 0; font-size: 1.2rem; }
        .ringkasan-total { text-align: center; margin-bottom: 20px; }
        .ringkasan-total h4 { font-size: 1rem; font-weight: 600; color: #555; }
        .ringkasan-total h2 { font-size: 2.5rem; font-weight: 600; margin: 0; color: var(--color-biru); }
        .ringkasan-akun, .ringkasan-laporan { display: flex; justify-content: space-between; background-color: #fdfdfd; border-radius: 5px; padding: 20px; margin-bottom: 15px; box-shadow: 0 3px 10px var(--color-bayangan); }
        .ringkasan-akun > div, .ringkasan-laporan > div { flex: 1; text-align: center; }
        .ringkasan-akun > div:first-of-type, .ringkasan-laporan > div:first-of-type { border-right: 1px solid #dedede; }
        .ringkasan-akun h4, .ringkasan-laporan h4 { font-size: 0.9rem; text-transform: uppercase; font-weight: 600; margin-bottom: 5px; }
        .ringkasan-akun .uang, .ringkasan-laporan .uang { font-size: 1.5rem; font-weight: 600; }
        .plus { color: var(--color-hijau); }
        .minus { color: var(--color-merah); }
        .filter-container { display: flex; gap: 15px; margin-bottom: 20px; background-color: #fdfdfd; padding: 15px; border-radius: 5px; box-shadow: 0 3px 10px var(--color-bayangan); }
        .filter-container > div { flex: 1; display: flex; flex-direction: column; }
        .filter-container label { font-size: 0.8rem; font-weight: 600; margin-bottom: 5px; color: #555; }
        .filter-container select, .filter-container input { border: 1px solid #dedede; border-radius: 5px; font-size: 1rem; padding: 8px; width: 100%; font-family: 'Poppins', sans-serif; background-color: #fff; }
        .riwayat-filter-container { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; background-color: #fdfdfd; padding: 15px; border-radius: 5px; box-shadow: 0 3px 10px var(--color-bayangan); margin-bottom: 20px; }
        .riwayat-filter-container .form-control { display: flex; flex-direction: column; }
        .riwayat-filter-container .form-control.full-width { grid-column: 1 / -1; }
        .riwayat-filter-container label { font-size: 0.8rem; font-weight: 600; margin-bottom: 5px; color: #555; }
        .riwayat-filter-container select, .riwayat-filter-container input { border: 1px solid #dedede; border-radius: 5px; font-size: 1rem; padding: 8px; width: 100%; font-family: 'Poppins', sans-serif; background-color: #fff; }
        .form { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        .form-control { display: flex; flex-direction: column; }
        .form-control.full-width { grid-column: 1 / -1; }
        .form-control label { margin-bottom: 5px; font-weight: 600; }
        .form-control input, .form-control select { border: 1px solid #dedede; border-radius: 5px; display: block; font-size: 1rem; padding: 12px; width: 100%; font-family: 'Poppins', sans-serif; background-color: #fff; }
        .btn { background-color: var(--color-biru); border: 0; border-radius: 5px; color: white; display: block; width: 100%; padding: 12px; font-size: 1.1rem; font-weight: 600; cursor: pointer; transition: background-color 0.3s ease; margin-top: 10px; }
        .btn:hover { background-color: #2980b9; }
        .list { list-style-type: none; padding: 0; margin-bottom: 25px; max-height: 400px; overflow-y: auto; }
        .list li { background-color: #fdfdfd; box-shadow: 0 2px 5px var(--color-bayangan); border-radius: 5px; display: flex; justify-content: space-between; align-items: center; position: relative; padding: 12px 15px; margin: 10px 0; }
        .list li.plus { border-left: 7px solid var(--color-hijau); }
        .list li.minus { border-left: 7px solid var(--color-merah); }
        .list li .info { flex-grow: 1; }
        .list li .info span { display: block; }
        .list li .info .deskripsi { font-weight: 600; font-size: 1.1rem; }
        .list li .info .detail { font-size: 0.8rem; color: #777; }
        .list li .jumlah { font-weight: 600; font-size: 1.1rem; white-space: nowrap; margin-left: 10px; }
        .list li.plus .jumlah { color: var(--color-hijau); }
        .list li.minus .jumlah { color: var(--color-merah); }
        .delete-btn { background-color: var(--color-merah); border: 0; color: white; font-size: 16px; padding: 5px 8px; position: absolute; left: -30px; top: 50%; transform: translateY(-50%); opacity: 0; transition: all 0.3s ease; cursor: pointer; border-radius: 3px; }
        .list li:hover .delete-btn { left: -10px; opacity: 1; }
        @media (max-width: 500px) { body { background-color: var(--color-box); justify-content: flex-start; } .container { width: 100%; margin: 0; padding: 20px; border-radius: 0; box-shadow: none; min-height: 100vh; } .tabs { margin: 0 -20px 20px -20px; } }
        
        /* --- [BARU] CSS untuk Layar Login --- */
        #login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--color-latar);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
        #login-screen h1 {
            font-size: 2rem;
            color: var(--color-teks);
            margin-bottom: 20px;
        }
        #btn-login {
            background-color: #4285F4; /* Warna Google */
            color: white;
            font-size: 1.1rem;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        
        /* --- [BARU] CSS untuk Tombol Logout --- */
        #btn-logout {
            background-color: var(--color-merah);
            color: white;
            font-size: 0.9rem;
            padding: 8px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 20px;
        }
    </style>
</head>
<body>

    <div id="login-screen">
        <h1>Pencatat Keuangan</h1>
        <button id="btn-login">üîë Login dengan Google</button>
    </div>

    <div class="container hidden"> 
    
        <nav class="tabs">
            <button id="tab-dashboard" class="active">üè† Dashboard</button>
            <button id="tab-riwayat">üìú Riwayat Transaksi</button>
        </nav>

        <div id="page-dashboard">
            <h3>Saldo Total Saat Ini</h3>
            <div class="ringkasan-total"><h2 id="saldo-total">Rp 0</h2></div>
            <div class="ringkasan-akun">
                <div><h4>Saldo ATM</h4><p id="saldo-atm" class="uang">Rp 0</p></div>
                <div><h4>Saldo Tunai</h4><p id="saldo-tunai" class="uang">Rp 0</p></div>
            </div>
            <h3>Laporan Bulanan</h3>
            <div class="filter-container">
                <div><label for="filter-bulan">Pilih Bulan</label><select id="filter-bulan"></select></div>
                <div><label for="filter-tahun">Pilih Tahun</label><select id="filter-tahun"></select></div>
            </div>
            <div class="ringkasan-laporan">
                <div><h4>Pemasukan (Bulan Ini)</h4><p id="laporan-masuk" class="uang plus">+Rp 0</p></div>
                <div><h4>Pengeluaran (Bulan Ini)</h4><p id="laporan-keluar" class="uang minus">-Rp 0</p></div>
            </div>
            <h3>Tambah Transaksi Baru</h3>
            <form id="form-tambah">
                <div class="form-control full-width"><label for="deskripsi">Deskripsi</label><input type="text" id="deskripsi" placeholder="Mis: Bayar Listrik..." required></div>
                <div class="form-control"><label for="jumlah">Jumlah</label><input type="number" id="jumlah" placeholder="Mis: 50000" required></div>
                <div class="form-control"><label for="tanggal">Tanggal</label><input type="date" id="tanggal" required></div>
                <div class="form-control"><label for="tipe">Tipe Transaksi</label><select id="tipe"><option value="pengeluaran">Pengeluaran</option><option value="pemasukan">Pemasukan</option></select></div>
                <div class="form-control"><label for="akun">Akun (Dompet)</label><select id="akun"><option value="ATM">ATM</option><option value="Tunai">Tunai</option></select></div>
                <div class="form-control full-width"><label for="kategori">Kategori</label><select id="kategori"></select></div>
                <button class="btn full-width">Tambah Transaksi</button>
            </form>
            
            <hr style="border: none; border-top: 1px solid #eee; margin-top: 30px;">
            <button id="btn-logout">Logout</button>
            
        </div>

        <div id="page-riwayat" class="hidden">
            <h3>Filter Riwayat Transaksi</h3>
            <div class="riwayat-filter-container">
                <div class="form-control"><label for="filter-tgl-mulai">Tanggal Mulai</label><input type="date" id="filter-tgl-mulai"></div>
                <div class="form-control"><label for="filter-tgl-akhir">Tanggal Akhir</label><input type="date" id="filter-tgl-akhir"></div>
                <div class="form-control"><label for="filter-kategori">Kategori</label><select id="filter-kategori"></select></div>
                <div class="form-control"><label for="filter-akun">Akun</label><select id="filter-akun"></select></div>
                <div class="form-control full-width"><label for="filter-tipe">Tipe Transaksi</label><select id="filter-tipe"></select></div>
                <button id="btn-apply-filter" class="btn full-width">Terapkan Filter</button>
            </div>
            <div class="ringkasan-laporan">
                <div><h4>Total Masuk (Filter)</h4><p id="riwayat-total-masuk" class="uang plus">+Rp 0</p></div>
                <div><h4>Total Keluar (Filter)</h4><p id="riwayat-total-keluar" class="uang minus">-Rp 0</p></div>
            </div>
            <ul id="riwayat-list" class="list"></ul>
        </div>
    </div>

    <script>
        // =======================================================
        // 1. KONFIGURASI FIREBASE (Milik Anda)
        // =======================================================
        const firebaseConfig = {
          apiKey: "AIzaSyd149n1-bjkVfVoZqfYGWZ0lLkTEkC_94",
          authDomain: "catatan-keuangan-ba599.firebaseapp.com",
          projectId: "catatan-keuangan-ba599",
          storageBucket: "catatan-keuangan-ba599.firebasestorage.app",
          messagingSenderId: "748657556647",
          appId: "1:748657556647:web:44cbbdd5b61a3521592f82"
        };
        // =======================================================

        // Inisialisasi Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth(); // [BARU] Inisialisasi Firebase Auth
        const transactionsCollection = db.collection("transactions");

        // === ELEMEN DOM ===
        const container = document.querySelector('.container'); // [BARU]
        const loginScreen = document.getElementById('login-screen'); // [BARU]
        const btnLogin = document.getElementById('btn-login'); // [BARU]
        const btnLogout = document.getElementById('btn-logout'); // [BARU]
        
        // (Elemen DOM lainnya sama)
        const saldoTotalEl = document.getElementById('saldo-total');
        const saldoAtmEl = document.getElementById('saldo-atm');
        // ... (semua elemen DOM lainnya sama persis) ...
        const saldoTunaiEl = document.getElementById('saldo-tunai');
        const formTambah = document.getElementById('form-tambah');
        const deskripsiInput = document.getElementById('deskripsi');
        const jumlahInput = document.getElementById('jumlah');
        const tanggalInput = document.getElementById('tanggal');
        const tipeInput = document.getElementById('tipe');
        const akunInput = document.getElementById('akun');
        const kategoriInput = document.getElementById('kategori');
        const filterBulanEl = document.getElementById('filter-bulan');
        const filterTahunEl = document.getElementById('filter-tahun');
        const laporanMasukEl = document.getElementById('laporan-masuk');
        const laporanKeluarEl = document.getElementById('laporan-keluar');
        const tabDashboard = document.getElementById('tab-dashboard');
        const tabRiwayat = document.getElementById('tab-riwayat');
        const pageDashboard = document.getElementById('page-dashboard');
        const pageRiwayat = document.getElementById('page-riwayat');
        const riwayatListEl = document.getElementById('riwayat-list');
        const btnApplyFilter = document.getElementById('btn-apply-filter');
        const filterTglMulai = document.getElementById('filter-tgl-mulai');
        const filterTglAkhir = document.getElementById('filter-tgl-akhir');
        const filterKategori = document.getElementById('filter-kategori');
        const filterAkun = document.getElementById('filter-akun');
        const filterTipe = document.getElementById('filter-tipe');
        const riwayatTotalMasuk = document.getElementById('riwayat-total-masuk');
        const riwayatTotalKeluar = document.getElementById('riwayat-total-keluar');

        // === DATA ===
        let transactions = []; 
        let unsubscribeDB = null; // [BARU] Untuk memutus listener saat logout
        const kategoriOptions = ["Makan & Jajan", "Bensin", "Paket Internet", "Iuran Kontrakan", "Belanja", "Hiburan", "Darurat", "Gaji / Pemasukan", "Uang Saku", "Lainnya"];
        const bulanOptions = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];

        // === FUNGSI ===
        
        // (Semua fungsi pembantu: formatRupiah, formatTanggal, dll
        //  TIDAK BERUBAH)
        
        function formatRupiah(angka) { /* ... (fungsi sama) ... */ 
            return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(angka);
        }
        function formatTanggal(dateString) { /* ... (fungsi sama) ... */ 
            const options = { year: 'numeric', month: 'short', day: 'numeric' };
            return new Date(dateString + 'T00:00:00-07:00').toLocaleDateString('id-ID', options);
        }
        
        // (Semua fungsi inti: addTransaction, updateSaldos, updateLaporanBulanan,
        //  removeTransaction, applyRiwayatFilter, createTransactionItem
        //  TIDAK BERUBAH, karena mereka hanya memproses array 'transactions')
        
        async function addTransaction(e) { /* ... (fungsi sama) ... */ 
            e.preventDefault(); 
            if (deskripsiInput.value.trim() === '' || jumlahInput.value.trim() === '' || tanggalInput.value.trim() === '') {
                alert('Mohon isi deskripsi, jumlah, dan tanggal.');
                return;
            }
            let jumlah = +jumlahInput.value;
            if (tipeInput.value === 'pengeluaran') {
                jumlah = -Math.abs(jumlah);
            } else {
                jumlah = Math.abs(jumlah);
            }
            const newTransaction = {
                tanggal: tanggalInput.value, 
                deskripsi: deskripsiInput.value,
                jumlah: jumlah,
                akun: akunInput.value,
                kategori: kategoriInput.value,
                createdAt: firebase.firestore.FieldValue.serverTimestamp() 
            };
            try {
                await transactionsCollection.add(newTransaction);
                const tDate = new Date(newTransaction.tanggal + 'T00:00:00-07:00');
                filterBulanEl.value = tDate.getMonth();
                filterTahunEl.value = tDate.getFullYear();
                formTambah.reset();
                tanggalInput.value = new Date().toISOString().split('T')[0];
                alert('Transaksi berhasil ditambahkan!');
            } catch (error) {
                console.error("Error adding document: ", error);
                alert("Gagal menyimpan data. Cek konsol (F12) untuk error.");
            }
        }
        function updateSaldos() { /* ... (fungsi sama) ... */ 
            const amounts = transactions.map(t => t.jumlah);
            const total = amounts.reduce((acc, item) => (acc += item), 0);
            const saldoATM = transactions.filter(t => t.akun === 'ATM').reduce((acc, t) => (acc += t.jumlah), 0);
            const saldoTunai = transactions.filter(t => t.akun === 'Tunai').reduce((acc, t) => (acc += t.jumlah), 0);
            saldoTotalEl.innerText = formatRupiah(total);
            saldoAtmEl.innerText = formatRupiah(saldoATM);
            saldoTunaiEl.innerText = formatRupiah(saldoTunai);
        }
        function updateLaporanBulanan() { /* ... (fungsi sama) ... */ 
            const bulan = parseInt(filterBulanEl.value);
            const tahun = parseInt(filterTahunEl.value);
            if (isNaN(bulan) || isNaN(tahun)) return;
            const filteredTransactions = transactions.filter(t => {
                const tDate = new Date(t.tanggal + 'T00:00:00-07:00'); 
                return tDate.getMonth() === bulan && tDate.getFullYear() === tahun;
            });
            const amounts = filteredTransactions.map(t => t.jumlah);
            const pemasukan = amounts.filter(item => item > 0).reduce((acc, item) => (acc += item), 0);
            const pengeluaran = amounts.filter(item => item < 0).reduce((acc, item) => (acc += item), 0) * -1;
            laporanMasukEl.innerText = `+${formatRupiah(pemasukan)}`;
            laporanKeluarEl.innerText = `-${formatRupiah(pengeluaran)}`;
        }
        window.removeTransaction = async function(id) { /* ... (fungsi sama) ... */ 
            if (confirm('Anda yakin ingin menghapus transaksi ini?')) {
                try {
                    await transactionsCollection.doc(id).delete();
                } catch (error) {
                    console.error("Error removing document: ", error);
                    alert("Gagal menghapus data.");
                }
            }
        }
        function applyRiwayatFilter() { /* ... (fungsi sama) ... */ 
            let filteredTransactions = [...transactions];
            const tglMulai = filterTglMulai.value; const tglAkhir = filterTglAkhir.value;
            const kategori = filterKategori.value; const akun = filterAkun.value; const tipe = filterTipe.value;
            if (tglMulai) { filteredTransactions = filteredTransactions.filter(t => t.tanggal >= tglMulai); }
            if (tglAkhir) { filteredTransactions = filteredTransactions.filter(t => t.tanggal <= tglAkhir); }
            if (kategori !== 'semua') { filteredTransactions = filteredTransactions.filter(t => t.kategori === kategori); }
            if (akun !== 'semua') { filteredTransactions = filteredTransactions.filter(t => t.akun === akun); }
            if (tipe === 'pemasukan') { filteredTransactions = filteredTransactions.filter(t => t.jumlah > 0); }
            else if (tipe === 'pengeluaran') { filteredTransactions = filteredTransactions.filter(t => t.jumlah < 0); }
            riwayatListEl.innerHTML = '';
            const sortedTransactions = filteredTransactions.sort((a, b) => new Date(b.tanggal) - new Date(a.tanggal));
            sortedTransactions.forEach(t => { const item = createTransactionItem(t); riwayatListEl.appendChild(item); });
            const amounts = filteredTransactions.map(t => t.jumlah);
            const pemasukan = amounts.filter(item => item > 0).reduce((acc, item) => (acc += item), 0);
            const pengeluaran = amounts.filter(item => item < 0).reduce((acc, item) => (acc += item), 0) * -1;
            riwayatTotalMasuk.innerText = `+${formatRupiah(pemasukan)}`;
            riwayatTotalKeluar.innerText = `-${formatRipiah(pengeluaran)}`;
        }
        function createTransactionItem(transaction) { /* ... (fungsi sama) ... */ 
            const jumlah = transaction.jumlah; const tanda = jumlah < 0 ? '' : '+';
            const itemClass = jumlah < 0 ? 'minus' : 'plus';
            const item = document.createElement('li'); item.classList.add(itemClass);
            item.innerHTML = `<button class="delete-btn" onclick="removeTransaction('${transaction.id}')">x</button><div class="info"><span class="deskripsi">${transaction.deskripsi}</span><span class="detail">${formatTanggal(transaction.tanggal)} | ${transaction.kategori} | ${transaction.akun}</span></div><span class="jumlah">${tanda}${formatRupiah(jumlah)}</span>`;
            return item;
        }
        
        // (Fungsi UI: populateFilters, tabs, dll TIDAK BERUBAH)
        
        function populateTahunFilter() { /* ... (fungsi sama) ... */ 
            const currentYear = new Date().getFullYear();
            const years = transactions.map(t => new Date(t.tanggal + 'T00:00:00-07:00').getFullYear());
            const uniqueYears = [...new Set(years)]; 
            if (uniqueYears.length === 0 || !uniqueYears.includes(currentYear)) { uniqueYears.push(currentYear); }
            uniqueYears.sort((a, b) => b - a); 
            const currentSelection = filterTahunEl.value;
            filterTahunEl.innerHTML = ''; 
            uniqueYears.forEach(year => { const option = document.createElement('option'); option.value = year; option.text = year; filterTahunEl.appendChild(option); });
            filterTahunEl.value = uniqueYears.includes(parseInt(currentSelection)) ? currentSelection : currentYear;
        }
        function populateAllFilters() { /* ... (fungsi sama) ... */ 
            const today = new Date(); const currentMonth = today.getMonth(); 
            kategoriInput.innerHTML = ''; filterKategori.innerHTML = '<option value="semua">Semua Kategori</option>';
            kategoriOptions.forEach(k => { kategoriInput.innerHTML += `<option value="${k}">${k}</option>`; filterKategori.innerHTML += `<option value="${k}">${k}</option>`; });
            filterBulanEl.innerHTML = '';
            bulanOptions.forEach((bulan, index) => { filterBulanEl.innerHTML += `<option value="${index}">${bulan}</option>`; });
            filterBulanEl.value = currentMonth;
            populateTahunFilter();
            filterAkun.innerHTML = '<option value="semua">Semua Akun</option><option value="ATM">ATM</option><option value="Tunai">Tunai</option>';
            filterTipe.innerHTML = '<option value="semua">Semua Tipe</option><option value="pemasukan">Pemasukan</option><option value="pengeluaran">Pengeluaran</option>';
            filterTglMulai.value = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
            filterTglAkhir.value = today.toISOString().split('T')[0];
        }
        function showDashboard() { /* ... (fungsi sama) ... */ 
            pageDashboard.classList.remove('hidden'); pageRiwayat.classList.add('hidden');
            tabDashboard.classList.add('active'); tabRiwayat.classList.remove('active');
            updateLaporanBulanan();
        }
        function showRiwayat() { /* ... (fungsi sama) ... */ 
            pageDashboard.classList.add('hidden'); pageRiwayat.classList.remove('hidden');
            tabDashboard.classList.remove('active'); tabRiwayat.classList.add('active');
            applyRiwayatFilter();
        }
        
        // --- [BARU] Fungsi-Fungsi Autentikasi ---
        
        // Tampilkan Aplikasi, Sembunyikan Login
        function showApp() {
            loginScreen.classList.add('hidden');
            container.classList.remove('hidden');
        }
        
        // Tampilkan Login, Sembunyikan Aplikasi
        function showLoginScreen() {
            loginScreen.classList.remove('hidden');
            container.classList.add('hidden');
        }
        
        // Fungsi untuk Login
        function signIn() {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider)
                .catch(error => {
                    console.error("Error saat login: ", error);
                    alert(error.message);
                });
        }
        
        // Fungsi untuk Logout
        function signOut() {
            auth.signOut();
        }
        
        // Fungsi untuk memuat data (dipanggil setelah login)
        function loadData() {
            // Hentikan listener lama jika ada (mencegah duplikat)
            if (unsubscribeDB) {
                unsubscribeDB();
            }
            
            // Mulai listener baru
            unsubscribeDB = transactionsCollection
                .orderBy("createdAt", "desc")
                .onSnapshot(snapshot => {
                    transactions = [];
                    snapshot.forEach(doc => {
                        transactions.push({ ...doc.data(), id: doc.id });
                    });
                    
                    // Update semua UI
                    updateSaldos();
                    populateTahunFilter(); 
                    updateLaporanBulanan();
                    if (!pageRiwayat.classList.contains('hidden')) {
                        applyRiwayatFilter();
                    }
                }, error => {
                    console.error("Error listening to transactions: ", error);
                    alert("Gagal mengambil data. Pastikan Aturan Keamanan (Rules) Anda benar.");
                });
        }
        
        // Fungsi untuk membersihkan data (dipanggil setelah logout)
        function clearData() {
            // Hentikan listener database
            if (unsubscribeDB) {
                unsubscribeDB();
                unsubscribeDB = null;
            }
            // Kosongkan data
            transactions = [];
            // Update UI agar bersih
            updateSaldos();
            updateLaporanBulanan();
            riwayatListEl.innerHTML = '';
            riwayatTotalMasuk.innerText = `+${formatRupiah(0)}`;
            riwayatTotalKeluar.innerText = `-${formatRupiah(0)}`;
        }
        

        // === FUNGSI INISIALISASI (BERUBAH) ===
        function init() {
            // Siapkan UI (Filter, Tab, dll)
            populateAllFilters(); 
            tanggalInput.value = new Date().toISOString().split('T')[0];
            
            // Pasang listener untuk tombol-tombol
            formTambah.addEventListener('submit', addTransaction);
            filterBulanEl.addEventListener('change', updateLaporanBulanan);
            filterTahunEl.addEventListener('change', updateLaporanBulanan);
            tabDashboard.addEventListener('click', showDashboard);
            tabRiwayat.addEventListener('click', showRiwayat);
            btnApplyFilter.addEventListener('click', applyRiwayatFilter);
            
            // [BARU] Pasang listener tombol Login & Logout
            btnLogin.addEventListener('click', signIn);
            btnLogout.addEventListener('click', signOut);

            // [BARU] Listener Utama Autentikasi
            // Ini adalah "penjaga" yang mengecek status login
            auth.onAuthStateChanged(user => {
                if (user) {
                    // --- PENGGUNA BERHASIL LOGIN ---
                    console.log("Pengguna login:", user.displayName);
                    showApp(); // Tampilkan aplikasi
                    loadData(); // Mulai ambil data dari database
                } else {
                    // --- PENGGUNA LOGOUT ---
                    console.log("Pengguna logout.");
                    showLoginScreen(); // Tampilkan layar login
                    clearData(); // Hentikan listener & bersihkan UI
                }
            });
        }

        // === JALANKAN APLIKASI ===
        init();

    </script>
</body>
</html>